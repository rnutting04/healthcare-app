{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "ChatBot" %} - {% trans "Healthcare Portal" %}{% endblock %}

{% block content %}
<div class="relative flex w-full h-[85vh]">
  <!-- Sidebar -->
  <div id="sidebar" class="fixed h-[85vh] md:relative z-40 bg-white border-r shadow-sm w-[300px] -translate-x-full md:translate-x-0">
    <div class="p-4 font-semibold border-b flex justify-between items-center">

        <span>
            {% trans "Dashboard" %}
        </span>
        <span id="chat-context-badge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">

        </span>
        <!-- Sidebar Collapse Icon -->
        <svg id="sidebar-close"
             xmlns="http://www.w3.org/2000/svg"
             class="hidden w-6 h-6 text-gray-700 cursor-pointer"
             fill="none"
             viewBox="0 0 24 24"
             stroke="currentColor"
             stroke-width="2"
             role="button"
             aria-label="Close sidebar">
          <rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke="currentColor" />
          <path d="M15 14l-4-4m0 0l4-4m-4 4h10" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
    </div>
    <div class="p-4">
      <button id="new-chat-button" class="w-full px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
        {% trans "+ New Chat" %}
      </button>
    </div>
    <span class="p-4 font-semibold text-sm">
        {% trans "Chat History" %}
    </span>
    <div class="p-4">
        <ul id="sessions-list" class="divide-y"></ul>
    </div>
  </div>


    <!-- Chat area -->
    <div class="flex-1 h-full flex justify-center items-stretch">
      <div class="w-full max-w-3xl bg-gray-50 flex flex-col rounded-r shadow-md">
        <!-- Header -->
        <div class="px-6 py-4 border-b bg-white flex items-center justify-between">        
            <!-- Sidebar toggle SVG -->
            <svg id="sidebar-toggle"
                 xmlns="http://www.w3.org/2000/svg"
                 class="w-6 h-6 text-gray-700 cursor-pointer md:hidden"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor"
                 stroke-width="2"
                 role="button"
                 aria-label="Toggle sidebar">
              <rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke="currentColor" />
              <path d="M9 10l4 4m0 0l-4 4m4-4H5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
              <h2 class="text-xl font-semibold text-gray-800" id="chat-title">
                {% trans "Chat with AI Assistant" %}
              </h2>
        </div>

        <!-- Messages -->
        <div class="flex-1 overflow-y-auto px-6 py-4 space-y-4" id="chat-box"></div>

        <!-- Message input -->
        <div class="border-t bg-white px-6 py-4">
          <div id="suggestion-container" class="mt-4 flex flex-wrap gap-2">
              <!-- Suggestion buttons -->
            </div>  
          <form id="chat-form" class="flex">
            <input id="chat-input" type="text" placeholder="{% trans 'Type your message...' %}"
              class="flex-1 border rounded px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <button
            id="send-button"
            type="submit"
            class="relative inline-flex items-center justify-center gap-2 px-4 py-2 rounded-md bg-blue-600 text-white ml-2 w-20 h-10 disabled:opacity-50 disabled:cursor-not-allowed"
            >
            <!-- centered overlay spinner -->
            <span
                id="send-spinner"
                class="absolute inset-0 m-auto hidden h-4 w-4 animate-spin"
                aria-hidden="true"
            >
                <svg class="h-full w-full" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </span>

            <!-- label: text + icon inline -->
            <span id="send-label" class="inline-flex items-center gap-1">
                <svg class="h-5 w-5 inline-block align-middle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                <span>Send</span>
            </span>
            </button>
          </form>
        </div>
      </div>
    </div>
</div>
<script>

const chatBox = document.getElementById('chat-box');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
const sendButton = document.getElementById('send-button');
const sendSpinner = document.getElementById('send-spinner');
const sendLabel = document.getElementById('send-label');
const sessionsList = document.getElementById('sessions-list');
const newChatButton = document.getElementById('new-chat-button');
const suggestionContainer = document.getElementById('suggestion-container');
const contextBadge = document.getElementById('chat-context-badge');
const initialMessage = "Hello! I'm your medical assistant. I can help answer questions about your condition based on medical documents. How can I help you today?"

let token = localStorage.getItem('access_token');
let sessionId = null;
let activeButton = null;
let mainCancerType = null;
let subCancerType = null;
let preferredLanguage = null;
let preferredInitialMessage = null;

const TRANSLATE_URL = "/api/translate/";     // POST /translate/
const RESULT_URL    = "/api/result";         // GET  /result/{id}

async function translateText(text, targetLang, token, {timeoutMs=10000, pollEveryMs=500} = {}) {
  if (targetLang == "en") {
    return text;
  }
  if (!text || !targetLang) return text;

  const res = await fetch(TRANSLATE_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`,
    },
    body: JSON.stringify({ text, target_language: targetLang })
  });

  // Cache hit (200)
  if (res.status === 200) {
    const data = await res.json();
    return data?.result ?? text;
  }

  // Accepted (202): poll /result/{request_id}
  if (res.status === 202) {
    const data = await res.json(); // { request_id: "..." }
    const id = data?.request_id;
    if (!id) return text;

    const started = Date.now();
    while (Date.now() - started < timeoutMs) {
      await new Promise(r => setTimeout(r, pollEveryMs));
      const r2 = await fetch(`${RESULT_URL}/${encodeURIComponent(id)}`, {
        headers: {"Authorization": `Bearer ${token}`}
      });

      if (r2.status === 200) {
        const body = await r2.json(); // { status: 'in_progress'|'completed'|'failed', result }
        if (body.status === "completed") return body.result ?? text;
        if (body.status === "failed") return text; // fallback
      } else if (r2.status === 404) {
        // not ready yet or expired; keep polling until timeout
      }
    }
    return text; // timeout fallback
  }

  return text;
}

async function translateArray(texts, targetLang, token) {
  const uniq = [...new Set(texts.filter(Boolean))];
  const map = new Map();
  await Promise.all(
    uniq.map(async (t) => {
      const tt = await translateText(t, targetLang, token);
      map.set(t, tt);
    })
  );
  return texts.map(t => map.get(t) ?? t);
}

function scrollToBottom() {
    chatBox.scrollTop = chatBox.scrollHeight;
}

function renderSessionButton(session) {
    const btn = document.createElement('div');
    btn.className = `flex items-center justify-between w-full text-left cursor-pointer hover:bg-gray-200 rounded-md px-4 py-2`
    if (session.id === sessionId) {
        btn.classList.add('bg-gray-300', 'font-medium');
        activeButton = btn;
    }

    btn.onclick = () => {
        if (session.id === sessionId) {
            return;
        }
        sessionId = session.id;
        loadSession(session.id);
        if (activeButton) activeButton.classList.remove('bg-gray-300', 'font-medium');
        btn.classList.add('bg-gray-300', 'font-medium');
        activeButton = btn;
        scrollToBottom();
    };

    const titleSpan = document.createElement('span');
    titleSpan.textContent = session.title || 'Untitled Chat';

    const deleteBtn = document.createElement('button');
    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-500 hover:text-red-700" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="2">
                            <g transform="scale(-1,1) translate(-24,0)">
                                <!-- Arched lid -->
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 6c0-1.1.9-2 2-2h2a2 2 0 012 2"/>
                                <!-- Lid body -->
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 7h14"/>
                                <!-- Trash can body -->
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 7l1.5 12a2 2 0 002 1.5h5a2 2 0 002-1.5L18 7"/>
                                <!-- Inner lines -->
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10 11v6M14 11v6"/>
                            </g>
                            </svg>`
                            ;
    deleteBtn.className = 'text-red-500 hover:text-red-700 ml-2';
    deleteBtn.onclick = async (e) => {
        e.stopPropagation();  // prevent loading the session when deleting
        await deleteSession(session.id);
        if (session.id === sessionId) {
            sessionId = null;
            chatBox.innerHTML = '';
        }
        loadSessions();
        chatBox.innerHTML = ''
        sessionId = null
        translateText(initialMessage, preferredLanguage, token).then(translated => {
            preferredInitialMessage = translated;
            appendMessage("assistant", translated);
        });

    };

    btn.appendChild(titleSpan);
    btn.appendChild(deleteBtn);

    return btn;
}

function appendMessage(role, content) {

  const msgWrapper = document.createElement('div');
  msgWrapper.className = `message-group mt-3 flex items-start gap-2 ${
    role === 'user' ? 'justify-end' : 'justify-start'
  }`;

  const icon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  icon.setAttribute("class", "h-5 w-5 " + (role === 'user' ? "text-blue-600" : "text-gray-600"));
  icon.setAttribute("viewBox", "0 0 24 24");
  icon.setAttribute("fill", role === 'user' ? "none" : "currentColor");
  if (role === 'user') {
    icon.setAttribute("stroke", "currentColor");
    icon.setAttribute("stroke-width", "2");
    icon.innerHTML = `<path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zM12 14.4c-4.8 0-8.4 2.4-8.4 4.8V21h16.8v-1.8c0-2.4-3.6-4.8-8.4-4.8z"/>`;
  } else {
    icon.innerHTML = `
      <path d="M3 5a2 2 0 012-2h14a2 2 0 012 2v11a2 2 0 01-2 2H8l-4 4v-4H5a2 2 0 01-2-2V5z"/>
      <path fill="#3B82F6" d="M12 7h-1v2H9v1h2v2h1v-2h2V9h-2V7z"/>
    `;
  }

  const contentCol = document.createElement('div');
  contentCol.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'} max-w-[75%]`;

  const bubble = document.createElement('div');
  bubble.className = (role === 'user'
    ? 'bg-blue-600 text-white'
    : 'bg-gray-200 text-gray-800') + ' p-3 rounded-lg text-sm whitespace-pre-line';

  bubble.textContent = content;

  contentCol.appendChild(bubble);

  if (role === 'user') {
    msgWrapper.appendChild(contentCol);
    msgWrapper.appendChild(icon);
  } else {
    msgWrapper.appendChild(icon);
    msgWrapper.appendChild(contentCol);
  }

  chatBox.appendChild(msgWrapper);
  scrollToBottom();

  return contentCol;
}

async function loadChatContext() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/patients/chat/context/', {
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                preferredLanguage = data.language;
                mainCancerType = data.main_cancer_type;
                subCancerType = data.sub_cancer_type;
                contextBadge.textContent = `${subCancerType} Cancer${data.is_fallback ? ' (Default)' : ''}`;
                contextBadge.title = data.is_fallback 
                    ? 'Using general uterine cancer information' 
                    : `Using ${subCancerType} cancer specific information`;
            }
        } catch (error) {
            console.error('Error loading chat context:', error);
            this.contextBadge.textContent = 'Context unavailable';
        }
    }

async function loadSessions() {
    const res = await fetch("/api/patients/chat/sessions/", {
        headers: { Authorization: "Bearer " + token }
    });
    const sessions = await res.json();
    if (!sessionId && sessions.length > 0) {
        sessionId = sessions[0].id;
    }
    sessionsList.innerHTML = '';
    sessions.forEach(s => {
        const btn = renderSessionButton(s);
        sessionsList.appendChild(btn);
    });
}

async function deleteSession(id) {
    await fetch(`/api/patients/chat/${id}/delete/`, {
        method: 'DELETE',
        headers: { Authorization: "Bearer " + token }
    });
}

async function loadSession(id) {
    const res = await fetch("/api/patients/chat/load/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ session_id: id })
    });

    if (res.ok) {
        sessionId = id;
        const data = await res.json();
        const messages = data.messages;
        chatBox.innerHTML = '';
        let bubble = null;
        for (const msg of data.messages) {
            bubble = appendMessage(msg.role, msg.content);
        }
      const localized = await translateArray(data.suggestions, preferredLanguage, token);

      renderSuggestionsUnderGroup(bubble, localized);
    } else {
        console.error("Failed to load session");
    }
}
const closeBtn = document.getElementById("sidebar-close");
const chatArea = document.getElementById("chat-area");
const sidebar = document.getElementById("sidebar");
const toggleBtn = document.getElementById("sidebar-toggle");

function handleResize() {
  const isMobile = window.innerWidth < 768; // Tailwind's md breakpoint

  if (!isMobile) {
    // Ensure sidebar is visible and close button is hidden on larger screens
    sidebar.classList.remove('-translate-x-full');
    sidebar.classList.add('translate-x-0');
    closeBtn.classList.add('hidden');
  } else {
    // On small screens, allow close icon to show again when sidebar is open
    if (!sidebar.classList.contains('-translate-x-full')) {
      closeBtn.classList.remove('hidden');
    }
  }
}

closeBtn.addEventListener('click', () => {
  sidebar.classList.add('-translate-x-full');
  sidebar.classList.remove('translate-x-0');
  closeBtn.classList.add('hidden');
});

toggleBtn.addEventListener('click', () => {
  sidebar.classList.remove('-translate-x-full');
  sidebar.classList.add('translate-x-0');
  closeBtn.classList.remove('hidden');
});

function clearAllSuggestions() {
  document.querySelectorAll('.suggestions-row').forEach(el => el.remove());
}

function renderSuggestionsUnderGroup(groupEl, suggestions) {
   
  if (!groupEl || !suggestions?.length) return;
  // remove any existing suggestions under this group (safety)
  groupEl.querySelector('.suggestions-row')?.remove();

  const row = document.createElement('div');
  row.className = 'suggestions-row mt-2 flex flex-wrap gap-2 self-start w-full';

  suggestions.slice(0, 4).forEach(s => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'text-xs text-white px-3 py-1 rounded-full bg-blue-500 hover:bg-blue-500/75';
    btn.textContent = s;
    btn.addEventListener('click', () => {
      clearAllSuggestions();          // hide chips as soon as user picks one
      appendMessage("user", s);
      sendMessage(s);
      chatInput.focus();
    });
    row.appendChild(btn);
  });

  groupEl.appendChild(row); // under the bubble, not to the right
}

async function sendMessage(message) {
    
        try {
             // Add AI typing indicator
            clearAllSuggestions();
            const typingElement = document.createElement('div');
            typingElement.className = "flex justify-start fade-in";
            typingElement.innerHTML = `
              <div class="bg-gray-200 text-gray-700 p-3 rounded-lg max-w-xs text-sm flex items-center space-x-1 animate-pulse">
                <span class="text-xs font-medium text-gray-500">AI is typing</span>
                <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                  <circle cx="4" cy="10" r="2" />
                  <circle cx="10" cy="10" r="2" />
                  <circle cx="16" cy="10" r="2" />
                </svg>
              </div>`;
            chatBox.appendChild(typingElement);
            scrollToBottom();
            let send = {
                message: message,
                initial_message: preferredInitialMessage,
                session_id: sessionId
            };
            const res = await fetch("/api/patients/chat/message/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify(
                    send
                )
            });
            const data = await res.json();
            const bubbleEl = appendMessage("assistant", data.response || data.error);
            sessionId = data.session_id;
            try {
              // Build last 5 messages as "role: text" (user/assistant)
              const sres = await fetch("/api/suggest/", {
                method: "POST",
                headers: {  
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
                },
                body: JSON.stringify({
                session_id: sessionId,
                cancer_type: mainCancerType
                })
              });
              const sdata = await sres.json();
              const suggestions = (sdata.top_4 || []).slice(0, 4);
              const localized = await translateArray(suggestions, preferredLanguage, token);

              renderSuggestionsUnderGroup(bubbleEl, localized);
              scrollToBottom();
            } catch (e) {
              // optional fallback for POC
                console.error(e);
            }
            if (typingElement) typingElement.remove();
            scrollToBottom();
             
        } catch (err) {
            console.error("Error sending message:", err);
        } finally {
            chatInput.disabled = false;
            sendButton.disabled = false;
            sendSpinner.classList.add("hidden");
            sendLabel.classList.remove("invisible");
        }
}

document.addEventListener("DOMContentLoaded", async () =>{
    // Initialize
    await loadSessions();
    await loadChatContext();
    // Call on resize and on initial load
    window.addEventListener('resize', handleResize);
    window.addEventListener('DOMContentLoaded', handleResize);
    if (sessionId){
        await loadSession(sessionId);
    } else {
        translateText(initialMessage, preferredLanguage, token).then(translated => {
            preferredInitialMessage = translated;
            appendMessage("assistant", translated);
        });
    }
    

    chatForm.addEventListener('submit', async function (e) {

        e.preventDefault();

        chatInput.disabled = true;
        sendButton.disabled = true;
        sendSpinner.classList.remove("hidden");
        sendLabel.classList.add("invisible");

        const message = chatInput.value.trim();
        if (!message) return;
    
        appendMessage("user", message);
        chatInput.value = "";
        await sendMessage(message);
        suggestionContainer.innerHTML = '';
        await loadSessions();
    });
    
    
    newChatButton.addEventListener("click", async () => {
        chatBox.innerHTML = ''
        sessionId = null
        translateText(initialMessage, preferredLanguage, token).then(translated => {
            preferredInitialMessage = translated;
            appendMessage("assistant", translated);
        });
    });
    
});
</script>
{% endblock %}
